name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install frontend deps
        run: pnpm -C frontend install --frozen-lockfile=false

      - name: Build frontend
        run: pnpm -C frontend build

      - name: Prepare release
        id: prep
        run: |
          echo "rel=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Rsync to server
        run: |
          RSYNC_FLAGS="-az --delete --exclude .git --exclude node_modules --exclude frontend/node_modules"
          REMOTE=${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}
          VPS_PATH=${{ secrets.VPS_PATH }}
          REL=${{ steps.prep.outputs.rel }}
          ENV_FILE="${{ secrets.ENV_FILE }}"
          ssh -o StrictHostKeyChecking=no $REMOTE "mkdir -p $VPS_PATH/releases/$REL $VPS_PATH/shared/uploads"
          rsync $RSYNC_FLAGS ./ $REMOTE:$VPS_PATH/releases/$REL/
          if [ -n "$ENV_FILE" ]; then
            ssh $REMOTE "ENV_FILE='$ENV_FILE' bash $VPS_PATH/releases/$REL/deploy/scripts/post_deploy.sh $REL"
          else
            ssh $REMOTE "bash $VPS_PATH/releases/$REL/deploy/scripts/post_deploy.sh $REL"
          fi


